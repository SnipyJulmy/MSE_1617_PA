\chapter{Diagram visualization}
\label{chap:diagram-visualization}

This chapter will present the visualization of the diagram. First, we will
introduce the intermediate model backend used by KlugHDL in order to produce an
output for further use. Then we will see the static and dynamic visualization
which are available with KlugHDL.

\section{Intermediate representation}
\label{sec:intermediate-representation}

The intermediate representation generate after the AST parsing is an
object-oriented representation created for KlugHDL. In order to use the
generated diagrams in other software we need to produce a standard output. In
KlugHDL those additional output are called ``backend''.

\subsection{The DOT backend}
\label{sec:dot-backend}

DOT and Graphviz are two software for diagram visualization. The diagram is
written using the ``dot'' language and then is compile to various image formats
like png or pdf.

The advantage of using DOT is the simplicity. The figure \ref{fig:dot-example-2}
show a Graphviz diagram generated by the DOT program. The corresponding code is
available in listing \ref{lst:dot-example-2}.

\begin{figure}[H]
  \centering
  \fbox{
    \digraph[scale=0.4]{DotExample2}{
      node [shape=record];
      graph [rankdir=LR,
      ranksep="1",
      nodesep="1"];
      AndGate [label="{{<a>io.a : Bool|<b>io.b : Bool}|AndGate|{<c>io.c : Bool}}"];
      OrGate [label="{{<a>io.a : Bool|<b>io.b : Bool}|OrGate|{<c>io.c : Bool}}"];
      Input [label="{Input|{<a>io.a : Bool|<b>io.b : Bool}}"];
      Output [label="{{<c>io.c : Bool}|Output}"];
      Input:a -> AndGate:a;
      Input:b -> AndGate:b;
      Input:a -> OrGate:a;
      Input:b -> OrGate:b;
      OrGate:c -> Output:c;
      AndGate:c -> Output:c;
    }
  }
  \caption[Example of a Graphviz diagram]{A complete graphviz diagram generated
    by DOT, the code of this example is available in listing \ref{lst:dot-example-2}}
  \label{fig:dot-example-2}
\end{figure}

\begin{figure}[H]
  \centering
  \begin{textcode}
    digraph g {
      node [shape=record];
      graph [rankdir=LR,ranksep="1",nodesep="1"];
      AndGate [label="{{<a>io.a : Bool|<b>io.b : Bool}|AndGate|{<c>io.c : Bool}}"];
      OrGate [label="{{<a>io.a : Bool|<b>io.b : Bool}|OrGate|{<c>io.c : Bool}}"];
      Input [label="{Input|{<a>io.a : Bool|<b>io.b : Bool}}"];
      Output [label="{{<c>io.c : Bool}|Output}"];
      Input:a -> AndGate:a;      Input:b -> AndGate:b;
      Input:a -> OrGate:a;       Input:b -> OrGate:b;
      OrGate:c -> Output:c;      AndGate:c -> Output:c;
    }
  \end{textcode}
  \caption[Example of a Graphviz program]{A complete example of a DOT program,
    the corresponding diagram is available in figure \ref{fig:dot-example-2}}
  \label{lst:dot-example-2}
\end{figure}

We could just notice that we use the \verb|shape=record| option of DOT in order
to generate the ports on the nodes and link them with the connection.

\subsection{The JSON backend}
\label{sec:json-backend}

JSON (JavaScript Object Notation) is a format mostly used by Javascript for
object serialization. The format is completely included in the Javascript
language which is able to directly understand the object notation without any
additional code to write.

At the beginning of the project, we try to produce the Javascript
output directly from the intermediate model. The problem is that if we change
the library we are using, we need to change the entire backend. The solution is
to produce a JSON output, whatever which library we are using, the model would
always be the same.

For this backend we used the lift json library \cite{liftweb}. The library is
very easy to use and offer a small DSL in order to write readable code. The
listing \ref{lst:lift-example} shows an example of the lift json library to create a
KlugHDL component in JSON.

\begin{listing}[H]
  \centering
  \begin{scalacode}
  def generateJson(klugHDLComponent: KlugHDLComponent): JValue = klugHDLComponent match {
    case KlugHDLComponentBasic(name, _, _) =>
      ("name" -> name) ~
      ("type" -> "default") ~
      ("ports" -> klugHDLComponent.ports.map(generateJson))
    case KlugHDLComponentIO(name, _) =>
      ("name" -> name) ~
      ("type" -> "io") ~
      ("ports" -> klugHDLComponent.ports.map(generateJson))
  }
  \end{scalacode}
  \caption[Lift library example : a json DSL]{The lift json library offer the
    opportunity to write readable and scalable code with her DSL}
  \label{lst:lift-example}
\end{listing}

\section{Static visualization}
\label{sec:static-visualization}

With KlugHDL it's very simple to generate a diagram in a pdf format. For example, this could be
useful for a report documentation. The listing \ref{lst:dot-example-klughdl}
shows how to do it with a complete example.

\begin{listing}[H]
  \centering
  \begin{scalacode}
  /**
   * Example for generating pdf diagam with dot
   * of a SpinalHDL component
  **/
   
   object DotExample extends App {

    // Create the vhdl rtl
    val report = SpinalConfig(targetDirectory = "vhdl").generateVhdl(new SmallComponent)

    // generate the diagram
    Dot(targetDirectory = "dot").generatePDFDiagram(Model(report.toplevel))
  }
  \end{scalacode}
  \caption[KlugHDL example on how to generate a pdf diagram]{A complete KlugHDL
    example on how to generate a pdf diagram using the Dot backend}
  \label{lst:dot-example-klughdl}
\end{listing}

\section{Dynamic visualization}
\label{sec:dynamic-visualization}

A dynamic diagram visualization is also provides with KlugHDL. The listing
\ref{lst:json-example-klughdl} illustrate how to generate the json model for a
SpinalHDL component.

\begin{listing}[H]
  \centering
  \begin{scalacode}
  /**
   * Example for generating the json model
   * of a SpinalHDL component
   **/

   object JsonExample extends App {
     
     // Create the vhdl rtl
    val report = SpinalConfig(targetDirectory = "vhdl").generateVhdl(new SmallComponent)

     // generate the model
     Json(targetDirectory = "json").generateJsonModel(Model(report.toplevel))
   }
  \end{scalacode}
  \caption[KlugHDL example on how to generate a json model]{A complete KlugHDL
    example on how to generate a json model}
  \label{lst:json-example-klughdl}
\end{listing}

\subsection{Extending the draw2d library}
\label{sec:draw2d-impl}

We have to extend the draw2d library in order to create the specific diagram we
want. The only addition to make is to create another node for draw2d. This is
done by extending the \verb|VerticalLayout| shape. The whole new shape is
created with the code in listing \ref{lst:component-shape}.

\begin{listing}[p]
  \centering
  \begin{jscode}
    ComponentShape = draw2d.shape.layout.VerticalLayout.extend({
      NAME: "ComponentShape",
      init: function (attr) {
          var _this = this;
          this._super($.extend({
              bgColor: "#ffffff",
              color: "#000000",
              stroke: 1,
              radius: 3
          }, attr));
          this.classLabel = new draw2d.shape.basic.Label({
              text: "ClassName",
              stroke: 1,
              fontColor: "#000000",
              bgColor: "#ffffff",
              radius: this.getRadius(),
              padding: 10,
              resizeable: true,
              editor: new draw2d.ui.LabelInplaceEditor(),
              onDoubleClick: function () {
                  _this.doubleClickCallBack()
              }
          });
          this.add(this.classLabel);
      },
      setName: function (name) {
          this.classLabel.setText(name);
      },
      getName: function () {
          return this.classLabel.text;
      },
      getPort: function (name) {
          return this.getPorts().find(function (entry) {
              return entry.name == name
          });
      },
      addPort: function (name, type) {
          var _this = this;
          var label = new draw2d.shape.basic.Label({
              text: name,
              stroke: 0,
              radius: 90,
              bgColor: null,
              padding: {left: 10, top: 3, right: 10, bottom: 5},
              fontColor: "#000000",
              resizeable: true,
              onDoubleClick: function () {
                  _this.doubleClickCallBack()
              },
              editor: new draw2d.ui.LabelEditor()
          });

          var port = label.createPort(type);
          port.setName(name);

          this.add(label);

          return label;
      },
      doubleClickCallBack: function () {
          console.log("double click callback")
      },
    });
  \end{jscode}
  \caption[Component shape prototype of KlugHDL]{A new prototype in draw2d is
    created by extending the VerticalLayout shape, then we have to provide a
    function for creating additional stack element in the shape}
  \label{lst:component-shape}
\end{listing}

The whole code for parsing the json model and display it into a web page is
available in the source code of the project.

\subsection{Problems}
\label{sec:problems}

For the moment, there is a problem with the navigation through the diagrams. The
navigation from parent to brothers is fine but in the other direction, from the
children to the parent, some components are, sometimes, calling the callback
method on the double click input multiple times. This create, first, a very long
callback and then corrupt the memory and raise exception.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../report"
%%% End:
